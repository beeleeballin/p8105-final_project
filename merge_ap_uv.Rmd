---
title: "Air Pollution and UV Data Merge"
output:
  html_document:
    code_folding: hide
---

Load packages.
```{r, message=F}
library(tidyverse)
library(rvest)
library(httr)
```

Scrape FIPS data and put it in a dataframe. See [USDA County FIPS](https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697).
```{r}
usda_countyfips = read_html("https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697")

countyfips_string =
  usda_countyfips %>%
  html_elements(".data") %>%
  html_text2()

countyfips_matrix = 
  matrix(
    data = unlist(strsplit(countyfips_string, split = "\r "))[-c(1:3)],
    ncol = 3, 
    byrow = TRUE
  )

countyfips_df =
  tibble(
    countyfips = countyfips_matrix[,1],
    county = countyfips_matrix[,2]
  ) %>%
  mutate(
    countyfips = as.numeric(countyfips)
  )
```

Load and tidy air pollution data. We have daily concentrations of 2 specific pollutants -- inhalable particles termed Particulate Matter, and ozone gas -- at the county level across the states from 2001 to 2016. The dataset has no missing values since the it is partially supported by a credible simulation model. For more information about our dataset and methods, see the relevant [CDC](https://ephtracking.cdc.gov/download) and [EPA](https://19january2017snapshot.epa.gov/air-research/downscaler-model-predicting-daily-air-pollution_.html) sites. 
```{r, message=F}
pm_df = 
  read_csv("../final_raw/Daily_PM2.5_Concentrations_All_County__2001-2016.csv") %>% 
  filter(statefips %in% c(36, 39, 23, 42)) %>% 
  janitor::clean_names() %>% 
  mutate(
    countyfips = statefips*1000 + countyfips,
    day = str_extract(date, "^\\d{2}"),
    day = factor(as.numeric(day)),
    month = str_extract(date, "[A-Z]{3}"),
    month = factor(month)
  )

oz_df = 
  read_csv("../final_raw/Daily_County-Level_Ozone_Concentrations__2001-2016.csv") %>% 
  filter(statefips %in% c(36, 39, 23, 42)) %>% 
  janitor::clean_names() %>% 
  mutate(
    countyfips = as.numeric(statefips)*1000 + countyfips,
    month = factor(month),
    day = factor(day)
  )

```

Similar to the air pollution data, we have daily UV measurements at the county level across the states from 2004 to 2015 with occasional missing data. As a result, we ruled out the years populated with missing values for analysis. 
```{r, message=F}
uv_df = 
  read_csv("../final_raw/Population-Weighted_Ultraviolet_Irradiance__2004-2015.csv") %>%
  filter(statefips %in% c(36, 39, 23, 42)) %>% 
  mutate(
    day = factor(as.numeric(day)),
    month = factor(month),
    month = recode_factor(month, `1` = "JAN", `2` = "FEB", `3` = "MAR", `4` = "APR",
                          `5` = "MAY", `6` = "JUN", `7` = "JUL", `8` = "AUG",
                          `9` = "SEP", `10` = "OCT", `11` = "NOV", `12` = "DEC", .default = "Other")
  )
```

Join the air pollution and UV data sensibly, and match the county names using the FIPS dataframe.
```{r}
ap_uv_df = 
  full_join(pm_df, oz_df, by = c("year", "countyfips", "month", "day")) %>% 
  full_join(., uv_df, by = c("year", "countyfips", "month", "day")) %>% 
  left_join(., countyfips_df, by = "countyfips") %>% 
  mutate(
    statefips = str_extract(countyfips, "^\\d{2}"),
    state = case_when(
      statefips == 36 ~ "NY",
      statefips == 39 ~ "OH",
      statefips == 23 ~ "ME",
      statefips == 42 ~ "PA"
    ),
    year = factor(year),
    state = factor(state),
    state = fct_relevel(state, "ME", "NY", "PA", "OH"),
    countyfips = factor(countyfips),
  ) %>% 
  select(-contains("statefips"), -date) %>% 
  select(year, month, day, countyfips, county, state, everything())
```

Export the large tidied dataframe whole and its summaries for our project.
```{r, message=F}
tidy_df =
  ap_uv_df %>% 
  mutate(
    season = case_when(
      month %in% (c("MAR", "APR", "MAY")) ~ "Spring",
      month %in% (c("JUN", "JUL", "AUG")) ~ "Summer",
      month %in% (c("SEP", "OCT", "NOV")) ~ "Fall",
      month %in% (c("DEC", "JAN", "FEB")) ~ "Winter"
    ), 
    season = factor(season),
    season = fct_relevel(season, "Spring", "Summer", "Fall", "Winter")
  ) %>% 
  filter(year %in% c(2005:2015)) %>% 
  group_by(year, countyfips, county, state, season) %>%
  summarize(across(pm25_max_pred:i380, median, na.rm = TRUE), 
            across(pm25_max_pred:i380, round, 2)) %>% 
  ungroup()

saveRDS(tidy_df,"ap/apuv_map/apuv.RDS")

extreme_value =
  bind_cols(
    tidy_df %>% 
      select(pm25_med_pred, o3_med_pred, edd)%>%
      summarize(across(pm25_med_pred:edd, max, na.rm =TRUE))
  ) %>%
  bind_cols(
    tidy_df %>%
      select(pm25_med_pred, o3_med_pred, edd) %>%
      summarize(across(pm25_med_pred:edd, min, na.rm =TRUE))
  )

saveRDS(extreme_value,"ap/apuv_map/ext_val.RDS")

knitr::kable(head(tidy_df, 7),
             format = "simple", 
             col.names = str_to_title(names(tidy_df))
)
```

