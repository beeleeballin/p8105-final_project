---
title: "mao on shiny dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(rjson)
library(plotly)
library(flexdashboard)
library(viridis)
```

```{r data_import}
df = 
  bind_rows(
    read_csv("~/Desktop/Columbia/Fall_2021/P8105-Data_Science/p8105-final_project/data/daily_ap/daily_ny_ap.csv")
  ) %>% 
  bind_rows(
    read_csv("~/Desktop/Columbia/Fall_2021/P8105-Data_Science/p8105-final_project/data/daily_ap/daily_oh_ap.csv")
  ) %>% 
  bind_rows(
    read_csv("~/Desktop/Columbia/Fall_2021/P8105-Data_Science/p8105-final_project/data/daily_ap/daily_me_ap.csv")
  ) %>% 
  bind_rows(
    read_csv("~/Desktop/Columbia/Fall_2021/P8105-Data_Science/p8105-final_project/data/daily_ap/daily_pa_ap.csv")
  )
  
tidy_df =
  df %>% 
  group_by(year, countyfips, county, state) %>%
  summarize(across(pm25_max_pred:o3_pop_pred, mean), 
            across(pm25_max_pred:o3_pop_pred, round, 2)) %>% 
  ungroup() %>% 
  mutate(
    hover = paste(county, '<br>', 
                  "PM 2.5:", '<br>',
                  "Average Daily Max", pm25_max_pred, '<br>',
                  "Average Daily Median", pm25_med_pred, '<br>',
                  "O3:", '<br>',
                  "Average Daily Max", o3_max_pred, '<br>',
                  "Average Daily Median", o3_med_pred),
    year = factor(year)
  ) %>% 
  rename("PM2.5" = pm25_mean_pred, "O3" = o3_mean_pred) %>% 
  select(year, countyfips, county, state, PM2.5, O3, hover)

extreme_value =
  tidy_df %>% 
  select(PM2.5, O3) %>% 
  summarize(across(c(PM2.5, O3), c(max, min)))
```

```{r}
url1 = 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'
counties = rjson::fromJSON(file = url1)
g = list(
  visible = FALSE,
  fitbounds = "locations"
)

map_gen = function(y, s, d){
  mx = mn = 0
  plot_title = ""
  
  new_df = tidy_df %>% 
    filter(year == y, state == s)
  if(d == "PM2.5"){
    new_df = rename(new_df, value = PM2.5)
    mx = pull(extreme_value, 1)
    mn = pull(extreme_value, 2)
    plot_title = "Average Daily PM 2.5 Level"
  }
  if(d == "O3"){
    new_df = rename(new_df, value = O3)
    mx = pull(extreme_value, 3)
    mn = pull(extreme_value, 4)
    plot_title = "Average Daily O3 Level"
  }
  select(new_df, countyfips, value, hover)
  
  plot_geo(new_df) %>% 
    add_trace(
      geojson = counties,
      locations = ~ countyfips,
      z = ~ value,
      text = ~ hover,
      
      colorscale = "Viridis",
      
      zmin = mn,
      zmax = mx,
      marker = 
        list(
          line = list(width = 0)
        )
    ) %>% 
    colorbar(title = "") %>%
    layout(
      title = plot_title,
      geo = g
    )
}
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
state_choices = 
  tidy_df %>% 
  distinct(state) %>% 
  pull()

selectInput(
  "state_choice",
  label = h3("Select State"),
  choices = state_choices,
  selected = "NY"
)

data_choices = 
  tidy_df %>% 
  select(PM2.5, O3) %>% 
  colnames()

selectInput(
  "data_choice",
  label = h3("Select Data"),
  choices = data_choices,
  selected = "PM2.5"
)

year_choices = 
  tidy_df %>% 
  distinct(year) %>% 
  pull()

selectInput(
  "year_choice",
  label = h3("Select Year"),
  choices = year_choices,
  selected = "2001"
)
```

Column {data-width=1000}
-----------------------------------------------------------------------

### Chart A

```{r}
renderPlotly({
  map_gen(input[["year_choice"]], input[["state_choice"]], input[["data_choice"]])
})
```