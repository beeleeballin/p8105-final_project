<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Regression Analyses</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="report.html">Report</a>
</li>
<li>
  <a href="merge_ap_uv.html">Climate Data</a>
</li>
<li>
  <a href="health_outcomes_data.html">Health Outcomes Data</a>
</li>
<li>
  <a href="https://bengoebel.shinyapps.io/apuv_map/">Data Exploration: Map</a>
</li>
<li>
  <a href="regression.html">Regression</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://drive.google.com/file/d/1OlPuJULEmn-XNHkTp1HBBtdBquJ1n4c3/view?usp=sharing">Screencast</a>
</li>
<li>
  <a href="mailto:&lt;johsuan.lee@columbia.edu&gt;">
    <span class="fa fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/beeleeballin/p8105-final_project">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://goo.gl/maps/kyKVwUbubgvP3u6s8">
    <span class="fa fa-map-marker fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Regression Analyses</h1>

</div>


<div id="part-1-state-level-trends-2001-2015" class="section level1">
<h1>Part 1: State Level Trends, 2001-2015</h1>
<div id="data" class="section level2">
<h2>Data</h2>
<p>We begin by reading in the combined health outcomes data, creating seasonal variables, and the combined air pollution and UV radiation data to produce an analysis at the state level. We quickly noticed that some of our variables in the air pollution and UV data were strongly correlated with each other, so we omitted several for the purposes of our regression analysis (collinearity violates our assumptions); the final correlation matrix is given below.</p>
<pre class="r"><code>library(tidyverse)

outcomes_state &lt;- read_csv(&quot;data/lc_mel_asthma_state.csv&quot;)
outcomes_county &lt;- read_csv(&quot;data/lc_mel_asthma_county.csv&quot;)
ap_uv &lt;- read_csv(&quot;ap/ap_uv/apuv.csv&quot;)

#State-level analysis - fewer predictors
ap_uv_state_slim &lt;- ap_uv %&gt;%
  select(-c(countyfips, county,
            pm25_max_pred, pm25_mean_pred, pm25_pop_pred,
            o3_max_pred, o3_mean_pred, o3_pop_pred,
            i310, i305, i380, edr)) %&gt;%
  group_by(state, year, season) %&gt;%
  #Take medians across county for each season
  summarize(across(pm25_med_pred:edd, median)) %&gt;%
  pivot_wider(names_from = season, values_from = pm25_med_pred:edd)

#State-level analysis - more predictors
ap_uv_state &lt;- ap_uv %&gt;%
  select(-c(countyfips, county)) %&gt;%
  group_by(state, year, season) %&gt;%
  #Take medians across county for each season
  summarize(across(pm25_max_pred:i380, median)) %&gt;%
  pivot_wider(names_from = season, values_from = pm25_max_pred:i380)

outcomes_wider_state &lt;- outcomes_state %&gt;%
  pivot_wider(names_from = outcome, values_from = age_adjusted_incidence_rate)
  
state_analysis &lt;- left_join(outcomes_wider_state, ap_uv_state_slim)

#Correlations
state_analysis_corr &lt;- state_analysis %&gt;% 
  select(`lung cancer`:edd_Winter) %&gt;% 
  do(as.data.frame(cor(., method=&quot;pearson&quot;, use=&quot;pairwise.complete.obs&quot;))) %&gt;%
  knitr::kable()
state_analysis_corr</code></pre>
<table style="width:100%;">
<colgroup>
<col width="8%" />
<col width="4%" />
<col width="4%" />
<col width="4%" />
<col width="7%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="6%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="4%" />
<col width="4%" />
<col width="4%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">lung cancer</th>
<th align="right">melanoma</th>
<th align="right">asthma</th>
<th align="right">pm25_med_pred_Fall</th>
<th align="right">pm25_med_pred_Spring</th>
<th align="right">pm25_med_pred_Summer</th>
<th align="right">pm25_med_pred_Winter</th>
<th align="right">o3_med_pred_Fall</th>
<th align="right">o3_med_pred_Spring</th>
<th align="right">o3_med_pred_Summer</th>
<th align="right">o3_med_pred_Winter</th>
<th align="right">edd_Fall</th>
<th align="right">edd_Spring</th>
<th align="right">edd_Summer</th>
<th align="right">edd_Winter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">lung cancer</td>
<td align="right">1.0000000</td>
<td align="right">0.2082952</td>
<td align="right">0.3107250</td>
<td align="right">0.8986288</td>
<td align="right">0.8198802</td>
<td align="right">0.7882240</td>
<td align="right">0.7974809</td>
<td align="right">0.1919442</td>
<td align="right">0.3188281</td>
<td align="right">0.7231695</td>
<td align="right">-0.7575209</td>
<td align="right">0.4423832</td>
<td align="right">0.3596362</td>
<td align="right">0.7183017</td>
<td align="right">0.1543232</td>
</tr>
<tr class="even">
<td align="left">melanoma</td>
<td align="right">0.2082952</td>
<td align="right">1.0000000</td>
<td align="right">-0.7112906</td>
<td align="right">-0.1634813</td>
<td align="right">-0.1539077</td>
<td align="right">-0.3414310</td>
<td align="right">0.1111093</td>
<td align="right">0.2199124</td>
<td align="right">-0.0692780</td>
<td align="right">-0.2151543</td>
<td align="right">0.1610076</td>
<td align="right">0.5326605</td>
<td align="right">0.3733857</td>
<td align="right">0.1302414</td>
<td align="right">0.3810257</td>
</tr>
<tr class="odd">
<td align="left">asthma</td>
<td align="right">0.3107250</td>
<td align="right">-0.7112906</td>
<td align="right">1.0000000</td>
<td align="right">0.1324778</td>
<td align="right">0.1347419</td>
<td align="right">0.3681750</td>
<td align="right">-0.1162262</td>
<td align="right">-0.4738109</td>
<td align="right">0.2878737</td>
<td align="right">0.0941785</td>
<td align="right">-0.0887587</td>
<td align="right">-0.6790830</td>
<td align="right">-0.5864353</td>
<td align="right">-0.3469688</td>
<td align="right">-0.4382772</td>
</tr>
<tr class="even">
<td align="left">pm25_med_pred_Fall</td>
<td align="right">0.8986288</td>
<td align="right">-0.1634813</td>
<td align="right">0.1324778</td>
<td align="right">1.0000000</td>
<td align="right">0.8990588</td>
<td align="right">0.8582926</td>
<td align="right">0.7793254</td>
<td align="right">0.2840132</td>
<td align="right">0.1924560</td>
<td align="right">0.7889453</td>
<td align="right">-0.8460845</td>
<td align="right">0.3921520</td>
<td align="right">0.3250380</td>
<td align="right">0.7189860</td>
<td align="right">0.1022595</td>
</tr>
<tr class="odd">
<td align="left">pm25_med_pred_Spring</td>
<td align="right">0.8198802</td>
<td align="right">-0.1539077</td>
<td align="right">0.1347419</td>
<td align="right">0.8990588</td>
<td align="right">1.0000000</td>
<td align="right">0.8303884</td>
<td align="right">0.7592112</td>
<td align="right">0.2658257</td>
<td align="right">0.2314727</td>
<td align="right">0.7210006</td>
<td align="right">-0.8427712</td>
<td align="right">0.2484149</td>
<td align="right">0.4710869</td>
<td align="right">0.7013698</td>
<td align="right">0.0388916</td>
</tr>
<tr class="even">
<td align="left">pm25_med_pred_Summer</td>
<td align="right">0.7882240</td>
<td align="right">-0.3414310</td>
<td align="right">0.3681750</td>
<td align="right">0.8582926</td>
<td align="right">0.8303884</td>
<td align="right">1.0000000</td>
<td align="right">0.6984350</td>
<td align="right">0.1996813</td>
<td align="right">0.2962791</td>
<td align="right">0.8374731</td>
<td align="right">-0.7890281</td>
<td align="right">0.1961149</td>
<td align="right">0.1081415</td>
<td align="right">0.6464591</td>
<td align="right">0.0891841</td>
</tr>
<tr class="odd">
<td align="left">pm25_med_pred_Winter</td>
<td align="right">0.7974809</td>
<td align="right">0.1111093</td>
<td align="right">-0.1162262</td>
<td align="right">0.7793254</td>
<td align="right">0.7592112</td>
<td align="right">0.6984350</td>
<td align="right">1.0000000</td>
<td align="right">0.4312721</td>
<td align="right">0.1888207</td>
<td align="right">0.6572143</td>
<td align="right">-0.7372041</td>
<td align="right">0.6325734</td>
<td align="right">0.2466810</td>
<td align="right">0.7032967</td>
<td align="right">0.1150974</td>
</tr>
<tr class="even">
<td align="left">o3_med_pred_Fall</td>
<td align="right">0.1919442</td>
<td align="right">0.2199124</td>
<td align="right">-0.4738109</td>
<td align="right">0.2840132</td>
<td align="right">0.2658257</td>
<td align="right">0.1996813</td>
<td align="right">0.4312721</td>
<td align="right">1.0000000</td>
<td align="right">0.0645681</td>
<td align="right">0.3550059</td>
<td align="right">-0.3152226</td>
<td align="right">0.7209518</td>
<td align="right">0.1174262</td>
<td align="right">0.5393190</td>
<td align="right">-0.0883089</td>
</tr>
<tr class="odd">
<td align="left">o3_med_pred_Spring</td>
<td align="right">0.3188281</td>
<td align="right">-0.0692780</td>
<td align="right">0.2878737</td>
<td align="right">0.1924560</td>
<td align="right">0.2314727</td>
<td align="right">0.2962791</td>
<td align="right">0.1888207</td>
<td align="right">0.0645681</td>
<td align="right">1.0000000</td>
<td align="right">0.2788961</td>
<td align="right">-0.2219670</td>
<td align="right">0.1439151</td>
<td align="right">0.4159598</td>
<td align="right">0.2821319</td>
<td align="right">0.1649401</td>
</tr>
<tr class="even">
<td align="left">o3_med_pred_Summer</td>
<td align="right">0.7231695</td>
<td align="right">-0.2151543</td>
<td align="right">0.0941785</td>
<td align="right">0.7889453</td>
<td align="right">0.7210006</td>
<td align="right">0.8374731</td>
<td align="right">0.6572143</td>
<td align="right">0.3550059</td>
<td align="right">0.2788961</td>
<td align="right">1.0000000</td>
<td align="right">-0.7726044</td>
<td align="right">0.3388034</td>
<td align="right">0.3831358</td>
<td align="right">0.8360440</td>
<td align="right">0.3144834</td>
</tr>
<tr class="odd">
<td align="left">o3_med_pred_Winter</td>
<td align="right">-0.7575209</td>
<td align="right">0.1610076</td>
<td align="right">-0.0887587</td>
<td align="right">-0.8460845</td>
<td align="right">-0.8427712</td>
<td align="right">-0.7890281</td>
<td align="right">-0.7372041</td>
<td align="right">-0.3152226</td>
<td align="right">-0.2219670</td>
<td align="right">-0.7726044</td>
<td align="right">1.0000000</td>
<td align="right">-0.2692265</td>
<td align="right">-0.3273758</td>
<td align="right">-0.6197914</td>
<td align="right">-0.1665205</td>
</tr>
<tr class="even">
<td align="left">edd_Fall</td>
<td align="right">0.4423832</td>
<td align="right">0.5326605</td>
<td align="right">-0.6790830</td>
<td align="right">0.3921520</td>
<td align="right">0.2484149</td>
<td align="right">0.1961149</td>
<td align="right">0.6325734</td>
<td align="right">0.7209518</td>
<td align="right">0.1439151</td>
<td align="right">0.3388034</td>
<td align="right">-0.2692265</td>
<td align="right">1.0000000</td>
<td align="right">0.2757208</td>
<td align="right">0.4563821</td>
<td align="right">0.1890074</td>
</tr>
<tr class="odd">
<td align="left">edd_Spring</td>
<td align="right">0.3596362</td>
<td align="right">0.3733857</td>
<td align="right">-0.5864353</td>
<td align="right">0.3250380</td>
<td align="right">0.4710869</td>
<td align="right">0.1081415</td>
<td align="right">0.2466810</td>
<td align="right">0.1174262</td>
<td align="right">0.4159598</td>
<td align="right">0.3831358</td>
<td align="right">-0.3273758</td>
<td align="right">0.2757208</td>
<td align="right">1.0000000</td>
<td align="right">0.3841069</td>
<td align="right">0.4020161</td>
</tr>
<tr class="even">
<td align="left">edd_Summer</td>
<td align="right">0.7183017</td>
<td align="right">0.1302414</td>
<td align="right">-0.3469688</td>
<td align="right">0.7189860</td>
<td align="right">0.7013698</td>
<td align="right">0.6464591</td>
<td align="right">0.7032967</td>
<td align="right">0.5393190</td>
<td align="right">0.2821319</td>
<td align="right">0.8360440</td>
<td align="right">-0.6197914</td>
<td align="right">0.4563821</td>
<td align="right">0.3841069</td>
<td align="right">1.0000000</td>
<td align="right">0.0915974</td>
</tr>
<tr class="odd">
<td align="left">edd_Winter</td>
<td align="right">0.1543232</td>
<td align="right">0.3810257</td>
<td align="right">-0.4382772</td>
<td align="right">0.1022595</td>
<td align="right">0.0388916</td>
<td align="right">0.0891841</td>
<td align="right">0.1150974</td>
<td align="right">-0.0883089</td>
<td align="right">0.1649401</td>
<td align="right">0.3144834</td>
<td align="right">-0.1665205</td>
<td align="right">0.1890074</td>
<td align="right">0.4020161</td>
<td align="right">0.0915974</td>
<td align="right">1.0000000</td>
</tr>
</tbody>
</table>
</div>
<div id="lung-cancer" class="section level2">
<h2>Lung Cancer</h2>
<div id="exploration" class="section level3">
<h3>Exploration</h3>
<p>Before performing our analysis, we may want to look at some bivariate plots with trends over time to see if there are general trends from 2001 to 2015.</p>
<pre class="r"><code>library(GGally)

state_analysis %&gt;%
  filter(year %in% 2001:2015) %&gt;%
  ggpairs(columns = c(&quot;year&quot;,&quot;lung cancer&quot;, &quot;o3_med_pred_Summer&quot;, &quot;pm25_med_pred_Summer&quot;),
          mapping = aes(group = state, color = state),
          columnLabels = c(&quot;Year&quot;, &quot;Lung Cancer/100,000&quot;,&quot;Median summer O3, ppm&quot;, &quot;PM 2.5, ug/m^3&quot;))</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>state_plot &lt;- state_analysis %&gt;%
  ggplot(aes(x = year, y = `lung cancer`, group = state, color = state)) +
  geom_path()

spring_plot &lt;- state_analysis %&gt;%
  ggplot(aes(x = o3_med_pred_Spring, y = `lung cancer`, group = state, color = state)) +
  geom_point()

summer_plot &lt;- state_analysis %&gt;%
  ggplot(aes(x = o3_med_pred_Summer, y = `lung cancer`, group = state, color = state)) +
  geom_point()

fall_plot &lt;- state_analysis %&gt;%
  ggplot(aes(x = o3_med_pred_Fall, y = `lung cancer`, group = state, color = state)) +
  geom_point()

library(patchwork)
(state_plot + spring_plot) / (summer_plot + fall_plot)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
</div>
<div id="model-fit---air-quality-and-lung-cancer" class="section level3">
<h3>Model Fit - Air quality and lung cancer</h3>
<p>We construct a model using the air quality variables (ozone, particulate matter), state, and powers and interactions thereof, then pare down with BIC, limiting our focus to the years 2001-2015.</p>
<pre class="r"><code>state_2001_2015 &lt;- state_analysis %&gt;%
  filter(year %in% 2001:2015) %&gt;%
  #exclude asthma, lots of missingness
  select(-asthma)

aq_lung_df &lt;- state_2001_2015 %&gt;%
  select(-c(melanoma, starts_with(&quot;edd&quot;)))
#fit_aq &lt;- lm(`lung cancer` ~ .^2, data = aq_lung_df) - this broke in R
fit_aq &lt;- lm(`lung cancer` ~ . +
               year*(o3_med_pred_Spring +
                     o3_med_pred_Summer +
                     o3_med_pred_Fall) +
               year*(pm25_med_pred_Spring +
                     pm25_med_pred_Summer +
                     pm25_med_pred_Fall) +
               state*year, data = aq_lung_df)

step_bic_aq &lt;- step(fit_aq, trace = 0, k = log(nobs(fit_aq)), direction = &quot;backward&quot;)
summary(step_bic_aq)</code></pre>
<pre><code>## 
## Call:
## lm(formula = `lung cancer` ~ state + year + pm25_med_pred_Fall + 
##     pm25_med_pred_Spring + o3_med_pred_Summer + year:pm25_med_pred_Fall + 
##     state:year, data = aq_lung_df)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.75773 -0.51795 -0.00639  0.51870  1.64145 
## 
## Coefficients:
##                           Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)             3402.03891  485.87390   7.002 3.80e-08 ***
## stateOH                 1209.53035  266.45723   4.539 6.40e-05 ***
## statePA                  543.09187  196.19321   2.768  0.00895 ** 
## year                      -1.65961    0.24187  -6.862 5.77e-08 ***
## pm25_med_pred_Fall      -299.22919   67.68656  -4.421 9.10e-05 ***
## pm25_med_pred_Spring      -0.65867    0.19252  -3.421  0.00160 ** 
## o3_med_pred_Summer        -0.10565    0.04746  -2.226  0.03254 *  
## year:pm25_med_pred_Fall    0.14930    0.03371   4.430 8.86e-05 ***
## stateOH:year              -0.59658    0.13271  -4.495 7.29e-05 ***
## statePA:year              -0.26793    0.09771  -2.742  0.00956 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.9403 on 35 degrees of freedom
## Multiple R-squared:  0.9738, Adjusted R-squared:  0.9671 
## F-statistic: 144.6 on 9 and 35 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Am I reading that right? <span class="math inline">\(R^2\)</span> of 0.97! That sounds too good to be true. Let’s look at some diagnostic plots.</p>
<pre class="r"><code>lung_fit &lt;- aq_lung_df %&gt;%
  modelr::add_residuals(step_bic_aq) %&gt;%
  modelr::add_predictions(step_bic_aq)

lung_fit %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>These residuals look great! Centered around 0 in a relatively even band. How about normality?</p>
<pre class="r"><code>plot(step_bic_aq, which = 2)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>That’s not ideal. I don’t love Box-Cox, but I wonder if it might give us some insight.</p>
<pre class="r"><code>MASS::boxcox(step_bic_aq)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Really doesn’t help us; the best power of our response variable is about 1. Are there any influential points/high-leverage points?</p>
<pre class="r"><code>plot(step_bic_aq, which = 5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>No datapoint with a Cook’s distance greater than 0.5, that’s good. Are we overfit?</p>
</div>
<div id="cross-validation" class="section level3">
<h3>Cross validation</h3>
<p>What happens if we cross-validate against simpler models? We will use leave-one-out and Monte Carlo cross-validation.</p>
<pre class="r"><code>library(modelr)
set.seed(15)
cv_df &lt;- crossv_loo(aq_lung_df)
    
cv_df &lt;- cv_df %&gt;% 
  mutate(
    #Ozone only
    ozone  = map(train, ~lm(`lung cancer` ~ o3_med_pred_Spring + o3_med_pred_Summer +
                              o3_med_pred_Fall, data = .x)),
    #Ozone with year and state
    ozone_state_year  = map(train, ~lm(`lung cancer` ~ o3_med_pred_Spring + o3_med_pred_Summer +
                                         o3_med_pred_Fall + year + state, data = .x)),
    #Ozone with year and state with time interactions
    ozone_state_year2  = map(train, ~lm(`lung cancer` ~ year*(o3_med_pred_Spring +
                                                              o3_med_pred_Summer +
                                                              o3_med_pred_Fall) + year + state +
                                                              year*state, data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_aq, data = .x)) %&gt;% 
  mutate(
    rmse_ozone = map2_dbl(ozone, test, ~rmse(model = .x, data = .y)),
    rmse_ozone_state_year = map2_dbl(ozone_state_year, test, ~rmse(model = .x, data = .y)),
    rmse_ozone_state_year2 = map2_dbl(ozone_state_year2, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Nice! Our BIC fit does the best on leave-one-out. What about Monte Carlo (1000 simulations, holdout 20%)?</p>
<pre class="r"><code>set.seed(15)
cv_df &lt;- crossv_mc(aq_lung_df, n = 1000)
    
cv_df &lt;- cv_df %&gt;% 
  mutate(
    #Ozone only
    ozone  = map(train, ~lm(`lung cancer` ~ o3_med_pred_Spring + o3_med_pred_Summer +
                              o3_med_pred_Fall, data = .x)),
    #Ozone with year and state
    ozone_state_year  = map(train, ~lm(`lung cancer` ~ o3_med_pred_Spring + o3_med_pred_Summer +
                                         o3_med_pred_Fall + year + state, data = .x)),
    #Ozone with year and state with time interactions
    ozone_state_year2  = map(train, ~lm(`lung cancer` ~ year*(o3_med_pred_Spring +
                                                              o3_med_pred_Summer +
                                                              o3_med_pred_Fall) + year + state +
                                                              year*state, data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_aq, data = .x)) %&gt;% 
  mutate(
    rmse_ozone = map2_dbl(ozone, test, ~rmse(model = .x, data = .y)),
    rmse_ozone_state_year = map2_dbl(ozone_state_year, test, ~rmse(model = .x, data = .y)),
    rmse_ozone_state_year2 = map2_dbl(ozone_state_year2, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Our BIC fit wins again. But there’s still something fishy. First, this model has 10 terms and just 45 datapoints - it should almost certainly be overfit, but it still cross-validates well. Second, the <span class="math inline">\(R^2\)</span> for this model is 0.97 - how can that be when it doesn’t include smoking, which is probably <em>the</em> main determinant of lung cancer? Which variables in this model are the most important?</p>
<pre class="r"><code>broom::tidy(step_bic_aq) %&gt;%
  mutate(
    abs_t = abs(statistic),
    term = as.factor(term),
    term = fct_reorder(term, abs_t)
    ) %&gt;%
  ggplot(aes(x = abs_t, y = term)) +
  geom_col() +
  labs(title = &quot;Relative Importance of Model Terms&quot;,
       y = &quot;Model Term&quot;, x = &quot;|t| statistic&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
</div>
<div id="melanoma-of-the-skin" class="section level2">
<h2>Melanoma of the Skin</h2>
<div id="exploration-1" class="section level3">
<h3>Exploration</h3>
<p>As before, we create several bivariate plots before constructing our model.</p>
<pre class="r"><code>state_analysis %&gt;%
  filter(year %in% 2001:2015) %&gt;%
  ggpairs(columns = c(&quot;year&quot;,&quot;melanoma&quot;,&quot;edd_Spring&quot;,&quot;edd_Summer&quot;),
          mapping = aes(group = state, color = state),
          columnLabels = c(&quot;Year&quot;, &quot;Melanoma/100,000&quot;, &quot;Spring EDD (J/m^2)&quot;, &quot;Summer EDD (J/m^2)&quot;))</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>That’s weird. There seem to be negative correlations between EDD and melanoma when we break down by state, but positive correlations overall—an instance of Simpson’s paradox.</p>
</div>
<div id="model-fit---melanoma-and-uv-radiation" class="section level3">
<h3>Model Fit - Melanoma and UV radiation</h3>
<p>How well does UV radiation predict melanoma? Let’s find out. This time we limit our analysis to 2005-2015.</p>
<pre class="r"><code>uv_df &lt;- state_2001_2015 %&gt;%
  filter(year &gt;= 2005) %&gt;%
  select(-c(starts_with(&quot;pm25&quot;), starts_with(&quot;o3&quot;), `lung cancer`))
  
mel_fit &lt;- lm(melanoma ~ .^2, data = uv_df)
step_bic_mel &lt;- step(mel_fit, trace = 0, k = log(nobs(mel_fit)), direction = &quot;backward&quot;)
summary(step_bic_mel)</code></pre>
<pre><code>## 
## Call:
## lm(formula = melanoma ~ state + year + edd_Fall + edd_Spring + 
##     edd_Summer + edd_Winter + state:year + state:edd_Fall + state:edd_Spring + 
##     state:edd_Summer + year:edd_Fall + year:edd_Spring + year:edd_Winter + 
##     edd_Fall:edd_Spring + edd_Fall:edd_Summer + edd_Fall:edd_Winter + 
##     edd_Spring:edd_Summer, data = uv_df)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.00663 -0.22621 -0.07181  0.16824  1.02878 
## 
## Coefficients:
##                         Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept)           -3.906e+03  3.716e+03  -1.051  0.31794   
## stateOH                6.941e+01  6.487e+02   0.107  0.91690   
## statePA               -1.975e+03  5.958e+02  -3.314  0.00783 **
## year                   1.675e+00  1.774e+00   0.944  0.36745   
## edd_Fall               4.838e+00  2.199e+00   2.200  0.05244 . 
## edd_Spring            -3.220e+00  1.205e+00  -2.673  0.02338 * 
## edd_Summer             1.609e-01  6.231e-02   2.582  0.02731 * 
## edd_Winter             1.139e+01  5.538e+00   2.056  0.06683 . 
## stateOH:year          -1.484e-01  3.204e-01  -0.463  0.65316   
## statePA:year           9.299e-01  2.881e-01   3.228  0.00905 **
## stateOH:edd_Fall       3.296e-02  1.307e-02   2.522  0.03029 * 
## statePA:edd_Fall       1.259e-02  5.626e-03   2.238  0.04917 * 
## stateOH:edd_Spring     1.704e-02  9.479e-03   1.797  0.10250   
## statePA:edd_Spring     2.490e-03  4.707e-03   0.529  0.60834   
## stateOH:edd_Summer     3.830e-02  1.258e-02   3.045  0.01235 * 
## statePA:edd_Summer     2.369e-02  8.521e-03   2.780  0.01945 * 
## year:edd_Fall         -2.257e-03  1.051e-03  -2.148  0.05722 . 
## year:edd_Spring        1.645e-03  5.939e-04   2.769  0.01981 * 
## year:edd_Winter       -5.636e-03  2.758e-03  -2.044  0.06825 . 
## edd_Fall:edd_Spring    2.190e-05  1.333e-05   1.643  0.13139   
## edd_Fall:edd_Summer   -8.768e-05  3.309e-05  -2.650  0.02433 * 
## edd_Fall:edd_Winter   -5.589e-05  3.489e-05  -1.602  0.14020   
## edd_Spring:edd_Summer -3.116e-05  1.509e-05  -2.065  0.06583 . 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.886 on 10 degrees of freedom
## Multiple R-squared:  0.9643, Adjusted R-squared:  0.8858 
## F-statistic: 12.28 on 22 and 10 DF,  p-value: 0.0001287</code></pre>
<p>This model is huge, it’s almost certainly overfit. I’m sure the diagnostics will be terrible.</p>
<pre class="r"><code>mel_df &lt;- uv_df %&gt;%
  modelr::add_residuals(step_bic_mel) %&gt;%
  modelr::add_predictions(step_bic_mel)

mel_df %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Residuals suggest a bit of heteroscedasticity and curvature but not as bad as I imagined. How about normality?</p>
<pre class="r"><code>plot(step_bic_mel, which = 2)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>Definitely not normal. High leverage points?</p>
<pre class="r"><code>plot(step_bic_mel, which = 5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>Several high leverage points. I think we want a different model. Lets’ try a simple one without interactions.</p>
<pre class="r"><code>mel_fit2 &lt;- lm(melanoma ~ ., data = uv_df)
summary(mel_fit2)</code></pre>
<pre><code>## 
## Call:
## lm(formula = melanoma ~ ., data = uv_df)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.0445 -1.0876 -0.1930  0.7735  2.6940 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -9.639e+02  1.916e+02  -5.031 3.44e-05 ***
## stateOH      6.496e+00  1.633e+00   3.978 0.000524 ***
## statePA      5.271e+00  1.186e+00   4.446 0.000157 ***
## year         5.008e-01  9.507e-02   5.268 1.86e-05 ***
## edd_Fall    -2.872e-03  2.427e-03  -1.183 0.247777    
## edd_Spring  -1.870e-03  1.459e-03  -1.282 0.211710    
## edd_Summer  -3.911e-03  2.221e-03  -1.761 0.090482 .  
## edd_Winter  -6.473e-03  5.996e-03  -1.080 0.290657    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.488 on 25 degrees of freedom
## Multiple R-squared:  0.7484, Adjusted R-squared:  0.6779 
## F-statistic: 10.62 on 7 and 25 DF,  p-value: 3.837e-06</code></pre>
<p>This comes at a big cost to explanatory power. Notably, the EDD variables aren’t significant. How do the residuals look?</p>
<pre class="r"><code>mel_df2 &lt;- uv_df %&gt;%
  modelr::add_residuals(mel_fit2) %&gt;%
  modelr::add_predictions(mel_fit2)

mel_df2 %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>We have curvature in the residuals. What is the source?</p>
<pre class="r"><code>summer_resid &lt;- mel_df2 %&gt;%
  ggplot(aes(x = edd_Summer, y = resid)) + geom_point() + labs(x = &quot;Summer Median EDD&quot;, y = &quot;Residual&quot;)

year_resid &lt;- mel_df2 %&gt;%
  ggplot(aes(x = year, y = resid)) + geom_point() + labs(x = &quot;Year&quot;, y = &quot;Residual&quot;)

fall_resid &lt;- mel_df2 %&gt;%
  ggplot(aes(x = edd_Fall, y = resid)) + geom_point() + labs(x = &quot;Fall Median EDD&quot;, y = &quot;Residual&quot;)

state_resid &lt;- mel_df2 %&gt;%
  ggplot(aes(x = state, y = resid)) + geom_violin() + labs(x = &quot;State&quot;, y = &quot;Residual&quot;)

(summer_resid + year_resid) / (fall_resid + state_resid)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>Seems like fall EDD and year might be the issues. Try transforming.</p>
<pre class="r"><code>mel_fit3 &lt;- lm(melanoma ~ state + I(1/year^3) + 
                 edd_Spring + edd_Summer + edd_Fall + edd_Winter,
                 data = uv_df)
summary(mel_fit3)</code></pre>
<pre><code>## 
## Call:
## lm(formula = melanoma ~ state + I(1/year^3) + edd_Spring + edd_Summer + 
##     edd_Fall + edd_Winter, data = uv_df)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -3.0451 -1.0908 -0.1952  0.7702  2.7017 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  3.778e+02  6.453e+01   5.855 4.16e-06 ***
## stateOH      6.492e+00  1.635e+00   3.970 0.000535 ***
## statePA      5.268e+00  1.187e+00   4.437 0.000160 ***
## I(1/year^3) -2.721e+12  5.179e+11  -5.254 1.94e-05 ***
## edd_Spring  -1.866e-03  1.461e-03  -1.277 0.213248    
## edd_Summer  -3.916e-03  2.224e-03  -1.760 0.090576 .  
## edd_Fall    -2.862e-03  2.430e-03  -1.178 0.249980    
## edd_Winter  -6.458e-03  6.005e-03  -1.075 0.292442    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.49 on 25 degrees of freedom
## Multiple R-squared:  0.7476, Adjusted R-squared:  0.677 
## F-statistic: 10.58 on 7 and 25 DF,  p-value: 3.97e-06</code></pre>
<pre class="r"><code>mel_df3 &lt;- uv_df %&gt;%
  modelr::add_residuals(mel_fit3) %&gt;%
  modelr::add_predictions(mel_fit3)

mel_df3 %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>Not much better. How are the other diagnostics?</p>
<pre class="r"><code>plot(mel_fit2, which = 2)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Not very normal…</p>
<pre class="r"><code>plot(mel_fit2, which = 5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>No high-leverage points. Are we overfit? We only have 33 rows.</p>
</div>
<div id="cross-validation-1" class="section level3">
<h3>Cross validation</h3>
<pre class="r"><code>set.seed(15)
cv_df &lt;- crossv_loo(uv_df)
    
cv_df &lt;- cv_df %&gt;% 
  mutate(
    #State and year only
    state_year = map(train, ~lm(melanoma ~ state + year, data = .x)),
    
    #EDD only
    edd = map(train, ~lm(melanoma ~ edd_Winter + edd_Spring + edd_Summer + edd_Fall, data = .x)),
    
    #EDD with year and state, linear
    edd_state_year = map(train, ~mel_fit2, data = .x),
    
    #EDD with year and state with time interactions
    edd_state_year2  = map(train, ~lm(melanoma ~ year*(edd_Winter +
                                                       edd_Spring +
                                                       edd_Summer +
                                                       edd_Fall) + year + state +
                                                       year*state, data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_mel, data = .x)) %&gt;% 
  mutate(
    rmse_state_year = map2_dbl(state_year, test, ~rmse(model = .x, data = .y)),
    rmse_edd = map2_dbl(edd, test, ~rmse(model = .x, data = .y)),
    rmse_edd_state_year = map2_dbl(edd_state_year, test, ~rmse(model = .x, data = .y)),
    rmse_edd_state_year2 = map2_dbl(edd_state_year2, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>The BIC fit wins? How? Will it survive 1000 Monte Carlo simulations?</p>
<pre class="r"><code>set.seed(15)
cv_df &lt;- crossv_mc(uv_df, 1000)

cv_df &lt;- cv_df %&gt;% 
  mutate(
    #State and year only
    state_year = map(train, ~lm(melanoma ~ state + year, data = .x)),
    
    #EDD only
    edd = map(train, ~lm(melanoma ~ edd_Winter + edd_Spring + edd_Summer + edd_Fall, data = .x)),
    
    #EDD with year and state, linear
    edd_state_year = map(train, ~mel_fit2, data = .x),
    
    #EDD with year and state with time interactions
    edd_state_year2  = map(train, ~lm(melanoma ~ year*(edd_Winter +
                                                       edd_Spring +
                                                       edd_Summer +
                                                       edd_Fall) + year + state +
                                                       year*state, data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_mel, data = .x)) %&gt;% 
  mutate(
    rmse_state_year = map2_dbl(state_year, test, ~rmse(model = .x, data = .y)),
    rmse_edd = map2_dbl(edd, test, ~rmse(model = .x, data = .y)),
    rmse_edd_state_year = map2_dbl(edd_state_year, test, ~rmse(model = .x, data = .y)),
    rmse_edd_state_year2 = map2_dbl(edd_state_year2, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>That model <em>must</em> be disgustingly overfit… right? How important is each variable?</p>
<pre class="r"><code>broom::tidy(step_bic_mel) %&gt;%
  mutate(
    abs_t = abs(statistic),
    term = as.factor(term),
    term = fct_reorder(term, abs_t)
    ) %&gt;%
  ggplot(aes(x = abs_t, y = term)) +
  geom_col() +
  labs(title = &quot;Relative Importance of Model Terms&quot;,
       y = &quot;Model Term&quot;, x = &quot;|t| statistic&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>However, we see a different pattern of importance from the model with just linear terms:</p>
<pre class="r"><code>broom::tidy(mel_fit2) %&gt;%
  mutate(
    abs_t = abs(statistic),
    term = as.factor(term),
    term = fct_reorder(term, abs_t)
    ) %&gt;%
  ggplot(aes(x = abs_t, y = term)) +
  geom_col() +
  labs(title = &quot;Relative Importance of Model Terms&quot;,
       y = &quot;Model Term&quot;, x = &quot;|t| statistic&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="part-2-cross-sectional-county-level-trends-2014-2018" class="section level1">
<h1>Part 2: Cross-Sectional County-Level Trends, 2014-2018</h1>
<p>Time is a significant predictor in many of the above models. Will we still have good models without it? In exchange, we get a lot more data - resolution at the county level instead of the state level.</p>
<p>We create our county-level dataframe:</p>
<pre class="r"><code>outcomes_wider_county &lt;- outcomes_county %&gt;%
  pivot_wider(names_from = outcome, values_from = age_adjusted_incidence_rate)

#county-level analysis - fewer predictors
ap_uv_county_slim &lt;- ap_uv %&gt;%
  filter(state %in% c(&quot;NY&quot;,&quot;OH&quot;,&quot;PA&quot;)) %&gt;%
  select(-c(pm25_max_pred, pm25_mean_pred, pm25_pop_pred,
            o3_max_pred, o3_mean_pred, o3_pop_pred, i324,
            i310, i305, i380, edr)) %&gt;%
  group_by(county, state, season) %&gt;%
  #Take medians across years for each season
  summarize(across(pm25_med_pred:edd, median, na.rm = TRUE)) %&gt;%
  pivot_wider(names_from = season, values_from = pm25_med_pred:edd)

county_df &lt;- right_join(outcomes_wider_county, ap_uv_county_slim)</code></pre>
<p>Again, we look at correlations among the predictors:</p>
<pre class="r"><code>county_corr &lt;- county_df %&gt;%
  select(pm25_med_pred_Fall:edd_Winter) %&gt;% 
  do(as.data.frame(cor(., method=&quot;pearson&quot;, use=&quot;pairwise.complete.obs&quot;))) %&gt;%
  knitr::kable()
county_corr</code></pre>
<table style="width:100%;">
<colgroup>
<col width="9%" />
<col width="8%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
<col width="7%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="4%" />
<col width="4%" />
<col width="4%" />
<col width="4%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">pm25_med_pred_Fall</th>
<th align="right">pm25_med_pred_Spring</th>
<th align="right">pm25_med_pred_Summer</th>
<th align="right">pm25_med_pred_Winter</th>
<th align="right">o3_med_pred_Fall</th>
<th align="right">o3_med_pred_Spring</th>
<th align="right">o3_med_pred_Summer</th>
<th align="right">o3_med_pred_Winter</th>
<th align="right">edd_Fall</th>
<th align="right">edd_Spring</th>
<th align="right">edd_Summer</th>
<th align="right">edd_Winter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">pm25_med_pred_Fall</td>
<td align="right">1.0000000</td>
<td align="right">0.9638443</td>
<td align="right">0.8616069</td>
<td align="right">0.9052818</td>
<td align="right">0.2291057</td>
<td align="right">0.0146364</td>
<td align="right">0.8384443</td>
<td align="right">-0.6956225</td>
<td align="right">0.7684484</td>
<td align="right">0.8022451</td>
<td align="right">0.8870468</td>
<td align="right">0.2349939</td>
</tr>
<tr class="even">
<td align="left">pm25_med_pred_Spring</td>
<td align="right">0.9638443</td>
<td align="right">1.0000000</td>
<td align="right">0.9158741</td>
<td align="right">0.9028251</td>
<td align="right">0.2809823</td>
<td align="right">0.0353524</td>
<td align="right">0.8916228</td>
<td align="right">-0.6912378</td>
<td align="right">0.7924249</td>
<td align="right">0.8272669</td>
<td align="right">0.8918020</td>
<td align="right">0.3220468</td>
</tr>
<tr class="odd">
<td align="left">pm25_med_pred_Summer</td>
<td align="right">0.8616069</td>
<td align="right">0.9158741</td>
<td align="right">1.0000000</td>
<td align="right">0.8265179</td>
<td align="right">0.2529572</td>
<td align="right">0.0051948</td>
<td align="right">0.8895923</td>
<td align="right">-0.6914356</td>
<td align="right">0.7773812</td>
<td align="right">0.8104157</td>
<td align="right">0.7624534</td>
<td align="right">0.4960550</td>
</tr>
<tr class="even">
<td align="left">pm25_med_pred_Winter</td>
<td align="right">0.9052818</td>
<td align="right">0.9028251</td>
<td align="right">0.8265179</td>
<td align="right">1.0000000</td>
<td align="right">-0.0004523</td>
<td align="right">-0.1934251</td>
<td align="right">0.8279097</td>
<td align="right">-0.7931456</td>
<td align="right">0.6843229</td>
<td align="right">0.7790970</td>
<td align="right">0.7957184</td>
<td align="right">0.3151852</td>
</tr>
<tr class="odd">
<td align="left">o3_med_pred_Fall</td>
<td align="right">0.2291057</td>
<td align="right">0.2809823</td>
<td align="right">0.2529572</td>
<td align="right">-0.0004523</td>
<td align="right">1.0000000</td>
<td align="right">0.8829294</td>
<td align="right">0.3808405</td>
<td align="right">0.3893814</td>
<td align="right">0.3971814</td>
<td align="right">0.2426730</td>
<td align="right">0.3636476</td>
<td align="right">0.0583694</td>
</tr>
<tr class="even">
<td align="left">o3_med_pred_Spring</td>
<td align="right">0.0146364</td>
<td align="right">0.0353524</td>
<td align="right">0.0051948</td>
<td align="right">-0.1934251</td>
<td align="right">0.8829294</td>
<td align="right">1.0000000</td>
<td align="right">0.1154320</td>
<td align="right">0.6116594</td>
<td align="right">0.1717104</td>
<td align="right">0.0137604</td>
<td align="right">0.1016028</td>
<td align="right">-0.0893092</td>
</tr>
<tr class="odd">
<td align="left">o3_med_pred_Summer</td>
<td align="right">0.8384443</td>
<td align="right">0.8916228</td>
<td align="right">0.8895923</td>
<td align="right">0.8279097</td>
<td align="right">0.3808405</td>
<td align="right">0.1154320</td>
<td align="right">1.0000000</td>
<td align="right">-0.6201207</td>
<td align="right">0.8356498</td>
<td align="right">0.8538449</td>
<td align="right">0.8446666</td>
<td align="right">0.4939809</td>
</tr>
<tr class="even">
<td align="left">o3_med_pred_Winter</td>
<td align="right">-0.6956225</td>
<td align="right">-0.6912378</td>
<td align="right">-0.6914356</td>
<td align="right">-0.7931456</td>
<td align="right">0.3893814</td>
<td align="right">0.6116594</td>
<td align="right">-0.6201207</td>
<td align="right">1.0000000</td>
<td align="right">-0.5442261</td>
<td align="right">-0.6571396</td>
<td align="right">-0.5928370</td>
<td align="right">-0.3705689</td>
</tr>
<tr class="odd">
<td align="left">edd_Fall</td>
<td align="right">0.7684484</td>
<td align="right">0.7924249</td>
<td align="right">0.7773812</td>
<td align="right">0.6843229</td>
<td align="right">0.3971814</td>
<td align="right">0.1717104</td>
<td align="right">0.8356498</td>
<td align="right">-0.5442261</td>
<td align="right">1.0000000</td>
<td align="right">0.9045582</td>
<td align="right">0.8531265</td>
<td align="right">0.6652107</td>
</tr>
<tr class="even">
<td align="left">edd_Spring</td>
<td align="right">0.8022451</td>
<td align="right">0.8272669</td>
<td align="right">0.8104157</td>
<td align="right">0.7790970</td>
<td align="right">0.2426730</td>
<td align="right">0.0137604</td>
<td align="right">0.8538449</td>
<td align="right">-0.6571396</td>
<td align="right">0.9045582</td>
<td align="right">1.0000000</td>
<td align="right">0.8444612</td>
<td align="right">0.6335905</td>
</tr>
<tr class="odd">
<td align="left">edd_Summer</td>
<td align="right">0.8870468</td>
<td align="right">0.8918020</td>
<td align="right">0.7624534</td>
<td align="right">0.7957184</td>
<td align="right">0.3636476</td>
<td align="right">0.1016028</td>
<td align="right">0.8446666</td>
<td align="right">-0.5928370</td>
<td align="right">0.8531265</td>
<td align="right">0.8444612</td>
<td align="right">1.0000000</td>
<td align="right">0.3542735</td>
</tr>
<tr class="even">
<td align="left">edd_Winter</td>
<td align="right">0.2349939</td>
<td align="right">0.3220468</td>
<td align="right">0.4960550</td>
<td align="right">0.3151852</td>
<td align="right">0.0583694</td>
<td align="right">-0.0893092</td>
<td align="right">0.4939809</td>
<td align="right">-0.3705689</td>
<td align="right">0.6652107</td>
<td align="right">0.6335905</td>
<td align="right">0.3542735</td>
<td align="right">1.0000000</td>
</tr>
</tbody>
</table>
<p>We average the particulate matter because the seasonal variables are highly correlated.</p>
<pre class="r"><code>county_df2 &lt;- county_df %&gt;%
  mutate(pm25_med_pred = rowMeans(select(., starts_with(&quot;pm25&quot;)))) %&gt;%
  select(-c(pm25_med_pred_Fall:pm25_med_pred_Winter))</code></pre>
<p>Now we can start the cross-sectional analysis.</p>
<div id="lung-cancer-cross-sectional-analysis" class="section level2">
<h2>Lung cancer, cross-sectional analysis</h2>
<div id="exploration-2" class="section level3">
<h3>Exploration</h3>
<pre class="r"><code>county_df2 %&gt;%
  ggpairs(columns = c(&quot;lung cancer&quot;, &quot;o3_med_pred_Summer&quot;, &quot;o3_med_pred_Fall&quot;, &quot;pm25_med_pred&quot;),
          mapping = aes(group = state, color = state),
          columnLabels = c(&quot;Lung Cancer/100,000&quot;,&quot;Median summer O3, ppm&quot;, &quot;Median fall O3, ppm&quot;,
                           &quot;PM 2.5, ug/m^3&quot;))</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<p>Some of these correlations seem quite flat, while others rather strong, and these trends can reverse when we break down by state.</p>
</div>
<div id="model-fit---lung-cancer-and-air-quality-cross-sectional-data" class="section level3">
<h3>Model fit - lung cancer and air quality, cross-sectional data</h3>
<p>Time for another model. Once more we try to predict lung cancer as a function of air quality variables.</p>
<pre class="r"><code>aq_lung_df2 &lt;- county_df2 %&gt;%
  select(-c(melanoma, asthma, starts_with(&quot;edd&quot;), county, fips))

fit_aq_cty &lt;- lm(`lung cancer` ~ .^2, data = aq_lung_df2)

step_bic_aq_cty &lt;- step(fit_aq_cty, trace = 0, k = log(nobs(fit_aq)), direction = &quot;backward&quot;)
summary(step_bic_aq_cty)</code></pre>
<pre><code>## 
## Call:
## lm(formula = `lung cancer` ~ state + o3_med_pred_Fall + o3_med_pred_Spring + 
##     o3_med_pred_Winter + state:o3_med_pred_Fall + state:o3_med_pred_Spring + 
##     o3_med_pred_Fall:o3_med_pred_Winter + o3_med_pred_Spring:o3_med_pred_Winter, 
##     data = aq_lung_df2)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -29.2067  -6.0740  -0.0349   6.4618  25.7443 
## 
## Coefficients:
##                                        Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                           -479.6378   191.3894  -2.506 0.012989 *  
## stateOH                                  4.8048    57.9248   0.083 0.933974    
## statePA                                157.7313    58.0866   2.715 0.007186 ** 
## o3_med_pred_Fall                       -34.9097    15.5973  -2.238 0.026290 *  
## o3_med_pred_Spring                      36.9504    14.4287   2.561 0.011163 *  
## o3_med_pred_Winter                      16.6532     7.2771   2.288 0.023137 *  
## stateOH:o3_med_pred_Fall                13.1302     2.6875   4.886 2.08e-06 ***
## statePA:o3_med_pred_Fall                 7.8972     2.7127   2.911 0.004000 ** 
## stateOH:o3_med_pred_Spring              -9.5845     2.7983  -3.425 0.000743 ***
## statePA:o3_med_pred_Spring              -9.3894     2.6316  -3.568 0.000448 ***
## o3_med_pred_Fall:o3_med_pred_Winter      1.0163     0.5109   1.989 0.047983 *  
## o3_med_pred_Spring:o3_med_pred_Winter   -1.0880     0.4819  -2.258 0.025020 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 9.595 on 204 degrees of freedom
##   (1 observation deleted due to missingness)
## Multiple R-squared:  0.4063, Adjusted R-squared:  0.3743 
## F-statistic: 12.69 on 11 and 204 DF,  p-value: &lt; 2.2e-16</code></pre>
<p><span class="math inline">\(R^2 = 0.37\)</span> is much more reasonable than what we were seeing before. Interestingly this model doesn’t have any particulate matter terms. How do the diagnostics look?</p>
<pre class="r"><code>lung_fit_cty &lt;- aq_lung_df2 %&gt;%
  modelr::add_residuals(step_bic_aq_cty) %&gt;%
  modelr::add_predictions(step_bic_aq_cty)

lung_fit_cty %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<p>We have some heteroscedasticity, but otherwise beautiful residuals. How about normality?</p>
<pre class="r"><code>plot(step_bic_aq_cty, which = 2)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<p>Not perfect, but a lot better than the state-level model. High-leverage points?</p>
<pre class="r"><code>plot(step_bic_aq_cty, which = 5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>No high-leverage points.</p>
</div>
<div id="cross-validation-2" class="section level3">
<h3>Cross-validation</h3>
<p>Are we overfit? We have 217 rows. Use Monte Carlo cross-validation against simpler models.</p>
<pre class="r"><code>set.seed(15)
cv_df &lt;- crossv_mc(aq_lung_df2, 1000)

cv_df &lt;- cv_df %&gt;% 
  mutate(
    #PM only
    pm = map(train, ~lm(`lung cancer` ~ pm25_med_pred, data = .x)),
    
    #O3 only
    o3 = map(train, ~lm(`lung cancer` ~ o3_med_pred_Fall +
                           o3_med_pred_Winter +
                           o3_med_pred_Spring +
                           o3_med_pred_Summer, data = .x)),
    
    #O3 and PM
    o3_pm = map(train, ~lm(`lung cancer` ~ o3_med_pred_Fall +
                           o3_med_pred_Winter +
                           o3_med_pred_Spring +
                           o3_med_pred_Summer +
                           pm25_med_pred, data = .x)),
    
    #O3, PM, and State
    o3_pm_state  = map(train, ~lm(`lung cancer` ~ ., data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_aq_cty, data = .x)) %&gt;% 
  mutate(
    rmse_pm25 = map2_dbl(pm, test, ~rmse(model = .x, data = .y)),
    rmse_o3 = map2_dbl(o3, test, ~rmse(model = .x, data = .y)),
    rmse_o3_pm25 = map2_dbl(o3_pm, test, ~rmse(model = .x, data = .y)),
    rmse_o3_pm25_state = map2_dbl(o3_pm_state, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>Once again the BIC model wins. But we actually shouldn’t be upset about it this time. Our model has 11 terms and 217 rows—it’s not like we only have 45 rows for that many predictors. Maybe it really isn’t overfit! How important are the predictors relative to one another?</p>
<pre class="r"><code>broom::tidy(step_bic_aq_cty) %&gt;%
  mutate(
    abs_t = abs(statistic),
    term = as.factor(term),
    term = fct_reorder(term, abs_t)
    ) %&gt;%
  ggplot(aes(x = abs_t, y = term)) +
  geom_col() +
  labs(title = &quot;Relative Importance of Model Terms&quot;,
       y = &quot;Model Term&quot;, x = &quot;|t| statistic&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<p>The strongest terms in this model are the state-by-ozone interactions. I wonder how much policy and industry differ between the two states.</p>
</div>
</div>
<div id="asthma-cross-sectional-analysis" class="section level2">
<h2>Asthma, cross-sectional analysis</h2>
<p>In the following analysis, we will only use those rows for which we have complete data (191), as there is some missingness in the response variable.</p>
<div id="exploration-3" class="section level3">
<h3>Exploration</h3>
<pre class="r"><code>asth_df &lt;- county_df2 %&gt;%
  filter(!is.na(asthma))

asth_df %&gt;%
  ggpairs(columns = c(&quot;asthma&quot;, &quot;o3_med_pred_Summer&quot;, &quot;o3_med_pred_Fall&quot;, &quot;pm25_med_pred&quot;),
          mapping = aes(group = state, color = state),
          columnLabels = c(&quot;Asthma/100,000&quot;,&quot;Median summer O3, ppm&quot;, &quot;Median fall O3, ppm&quot;,
                           &quot;PM 2.5, ug/m^3&quot;))</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<p>None of these exposures seem very strongly correlated with the outcome, though summer ozone correlates pretty strongly with particulate matter. Also, we may have some outliers.</p>
</div>
<div id="model-fit" class="section level3">
<h3>Model Fit</h3>
<pre class="r"><code>aq_asth_df &lt;- asth_df %&gt;%
  select(-c(melanoma, `lung cancer`, starts_with(&quot;edd&quot;), county, fips))

fit_asth_cty &lt;- lm(asthma ~ .^2, data = aq_asth_df)

step_bic_asth_cty &lt;- step(fit_asth_cty, trace = 0, k = log(nobs(fit_aq)), direction = &quot;backward&quot;)
summary(step_bic_asth_cty)</code></pre>
<pre><code>## 
## Call:
## lm(formula = asthma ~ state + o3_med_pred_Fall + o3_med_pred_Spring + 
##     state:o3_med_pred_Fall + o3_med_pred_Fall:o3_med_pred_Spring, 
##     data = aq_asth_df)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -115.202  -12.168   -1.760    8.629  244.506 
## 
## Coefficients:
##                                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                         3915.2387   613.0669   6.386 1.34e-09 ***
## stateOH                               62.9317   138.5573   0.454  0.65022    
## statePA                              391.3805   146.8512   2.665  0.00838 ** 
## o3_med_pred_Fall                    -115.7822    21.1637  -5.471 1.44e-07 ***
## o3_med_pred_Spring                   -86.7224    15.5627  -5.572 8.77e-08 ***
## stateOH:o3_med_pred_Fall              -2.6666     4.4104  -0.605  0.54617    
## statePA:o3_med_pred_Fall             -12.6007     4.6982  -2.682  0.00798 ** 
## o3_med_pred_Fall:o3_med_pred_Spring    2.6020     0.5183   5.020 1.21e-06 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 30.13 on 185 degrees of freedom
## Multiple R-squared:  0.597,  Adjusted R-squared:  0.5817 
## F-statistic: 39.15 on 7 and 185 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Strong <span class="math inline">\(R^2\)</span> value but not absurd. Weird that fall ozone is protective (and strongly so). How do the residuals look?</p>
<pre class="r"><code>asth_cty &lt;- aq_asth_df %&gt;%
  modelr::add_residuals(step_bic_asth_cty) %&gt;%
  modelr::add_predictions(step_bic_asth_cty)

asth_cty %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<p>Holy outliers, Batman!</p>
<pre class="r"><code>plot(step_bic_asth_cty, which = 5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<p>We should filter out those high-leverage points and refit.</p>
<pre class="r"><code>aq_asth_df2 &lt;- aq_asth_df %&gt;%
  slice(-c(3,31,185))

fit_asth_cty &lt;- lm(asthma ~ .^2, data = aq_asth_df2)

step_bic_asth_cty &lt;- step(fit_asth_cty, trace = 0, k = log(nobs(fit_aq)), direction = &quot;backward&quot;)
summary(step_bic_asth_cty)</code></pre>
<pre><code>## 
## Call:
## lm(formula = asthma ~ state + o3_med_pred_Fall + o3_med_pred_Spring + 
##     o3_med_pred_Winter + state:o3_med_pred_Fall + state:o3_med_pred_Winter, 
##     data = aq_asth_df2)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -44.875 -11.021  -0.954   8.533  63.721 
## 
## Coefficients:
##                            Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                523.0156    56.8882   9.194  &lt; 2e-16 ***
## stateOH                     42.6557    76.5167   0.557 0.577899    
## statePA                    -82.5309    94.0678  -0.877 0.381463    
## o3_med_pred_Fall            -0.6742     2.6691  -0.253 0.800855    
## o3_med_pred_Spring          -6.7508     2.2294  -3.028 0.002823 ** 
## o3_med_pred_Winter          -4.5638     1.6210  -2.815 0.005414 ** 
## stateOH:o3_med_pred_Fall    11.9977     3.5559   3.374 0.000907 ***
## statePA:o3_med_pred_Fall    -4.6986     3.8175  -1.231 0.220011    
## stateOH:o3_med_pred_Winter -16.8004     4.3672  -3.847 0.000166 ***
## statePA:o3_med_pred_Winter   7.2681     2.4625   2.951 0.003584 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 18.25 on 180 degrees of freedom
## Multiple R-squared:  0.6123, Adjusted R-squared:  0.5929 
## F-statistic: 31.59 on 9 and 180 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>What does it look like now?</p>
<pre class="r"><code>asth_cty &lt;- aq_asth_df2 %&gt;%
  modelr::add_residuals(step_bic_asth_cty) %&gt;%
  modelr::add_predictions(step_bic_asth_cty)

asth_cty %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-41-1.png" width="672" /></p>
<pre class="r"><code>plot(step_bic_asth_cty, which = 2)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<p>Outliers are gone… but we have serious abnormality. Tried to transform by taking the square root of the response, but it wasn’t better.</p>
</div>
<div id="cross-validation-3" class="section level3">
<h3>Cross-validation</h3>
<p>Sometimes a smaller model is better. Is this one of those times?</p>
<pre class="r"><code>set.seed(15)
cv_df &lt;- crossv_mc(aq_asth_df2, 1000)

cv_df &lt;- cv_df %&gt;% 
  mutate(
    #PM only
    pm = map(train, ~lm(asthma ~ pm25_med_pred, data = .x)),
    
    #O3 only
    o3 = map(train, ~lm(asthma ~ o3_med_pred_Fall +
                           o3_med_pred_Winter +
                           o3_med_pred_Spring +
                           o3_med_pred_Summer, data = .x)),
    
    #O3 and PM
    o3_pm = map(train, ~lm(asthma ~ o3_med_pred_Fall +
                           o3_med_pred_Winter +
                           o3_med_pred_Spring +
                           o3_med_pred_Summer +
                           pm25_med_pred, data = .x)),
    
    #O3, PM, and State
    o3_pm_state  = map(train, ~lm(asthma ~ ., data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_asth_cty, data = .x)) %&gt;% 
  mutate(
    rmse_pm25 = map2_dbl(pm, test, ~rmse(model = .x, data = .y)),
    rmse_o3 = map2_dbl(o3, test, ~rmse(model = .x, data = .y)),
    rmse_o3_pm25 = map2_dbl(o3_pm, test, ~rmse(model = .x, data = .y)),
    rmse_o3_pm25_state = map2_dbl(o3_pm_state, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-43-1.png" width="672" /></p>
<p>This is pretty weird. What terms are the most important, according to the BIC model?</p>
<pre class="r"><code>broom::tidy(step_bic_asth_cty) %&gt;%
  mutate(
    abs_t = abs(statistic),
    term = as.factor(term),
    term = fct_reorder(term, abs_t)
    ) %&gt;%
  ggplot(aes(x = abs_t, y = term)) +
  geom_col() +
  labs(title = &quot;Relative Importance of Model Terms&quot;,
       y = &quot;Model Term&quot;, x = &quot;|t| statistic&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<p>State interactions with ozone again? This might be something to research.</p>
</div>
</div>
<div id="melanoma-of-the-skin-cross-sectional-analysis" class="section level2">
<h2>Melanoma of the skin, cross-sectional analysis</h2>
<pre class="r"><code>county_df2 %&gt;%
  ggpairs(columns = c(&quot;melanoma&quot;, &quot;edd_Summer&quot;, &quot;edd_Fall&quot;, &quot;edd_Winter&quot;, &quot;edd_Spring&quot;),
          mapping = aes(group = state, color = state),
          columnLabels = c(&quot;Melanoma/100,000&quot;,&quot;Median summer EDD&quot;, &quot;Median fall EDD&quot;,
                           &quot;Median winter EDD&quot;, &quot;Median spring EDD&quot;))</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-45-1.png" width="672" /></p>
<p>No season has a strong correlation with melanoma, but the seasons are moderately to strongly correlated with one another, spring and fall especially.</p>
<div id="model-fit-melanoma-and-solar-uv-radiation-cross-sectional-data" class="section level3">
<h3>Model fit, melanoma and solar UV radiation, cross-sectional data</h3>
<pre class="r"><code>mel_cty &lt;- county_df2 %&gt;%
  select(state, melanoma, starts_with(&quot;edd&quot;))

fit_mel_cty &lt;- lm(melanoma ~ .^2 +
                    I(edd_Spring^3) +
                    I(edd_Summer^3) +
                    I(edd_Fall^3) +
                    I(edd_Winter^3), data = mel_cty)

step_bic_mel_cty &lt;- step(fit_mel_cty, trace = 0, k = log(nobs(fit_aq)), direction = &quot;backward&quot;)
summary(step_bic_mel_cty)</code></pre>
<pre><code>## 
## Call:
## lm(formula = melanoma ~ state + edd_Spring + edd_Summer + edd_Winter + 
##     state:edd_Winter + edd_Spring:edd_Winter + edd_Summer:edd_Winter, 
##     data = mel_cty)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -13.7539  -3.3520   0.1517   3.4794  16.4805 
## 
## Coefficients:
##                         Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)            8.642e+01  9.886e+01   0.874 0.383052    
## stateOH               -2.945e+01  1.061e+01  -2.775 0.006047 ** 
## statePA               -4.457e+01  7.531e+00  -5.919 1.37e-08 ***
## edd_Spring             8.822e-02  2.279e-02   3.871 0.000146 ***
## edd_Summer            -6.128e-02  2.947e-02  -2.079 0.038860 *  
## edd_Winter            -2.670e-01  2.167e-01  -1.232 0.219272    
## stateOH:edd_Winter     5.758e-02  2.258e-02   2.550 0.011523 *  
## statePA:edd_Winter     9.511e-02  1.552e-02   6.129 4.56e-09 ***
## edd_Spring:edd_Winter -1.800e-04  4.913e-05  -3.663 0.000318 ***
## edd_Summer:edd_Winter  1.600e-04  6.446e-05   2.482 0.013879 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 4.903 on 202 degrees of freedom
##   (5 observations deleted due to missingness)
## Multiple R-squared:  0.267,  Adjusted R-squared:  0.2343 
## F-statistic: 8.175 on 9 and 202 DF,  p-value: 2.477e-10</code></pre>
<p>Once again we have a relatively modest <span class="math inline">\(R^2\)</span> (0.23). How do the residuals look?</p>
<pre class="r"><code>mel_fit_cty &lt;- mel_cty %&gt;%
  modelr::add_residuals(step_bic_mel_cty) %&gt;%
  modelr::add_predictions(step_bic_mel_cty)

mel_fit_cty %&gt;%
  ggplot(aes(x = pred, y = resid)) + geom_point() + labs(x = &quot;Predicted value&quot;, y = &quot;Residual&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-47-1.png" width="672" /></p>
<p>We have some heteroscedasticity but doesn’t look all that bad. Is it normal?</p>
<pre class="r"><code>plot(step_bic_mel_cty, which = 2)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
<p>Not ideal, but mostly ok. High-leverage points?</p>
<pre class="r"><code>plot(step_bic_mel_cty, which = 5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
<p>No high-leverage points (Cook’s D &gt;0.5).</p>
</div>
<div id="cross-validation-4" class="section level3">
<h3>Cross validation</h3>
<pre class="r"><code>set.seed(15)
cv_df &lt;- crossv_mc(mel_cty, 1000)

cv_df &lt;- cv_df %&gt;% 
  mutate(
    #Summer EDD only
    summer_edd = map(train, ~lm(melanoma ~ edd_Summer, data = .x)),
    
    #Summer and fall
    summer_fall = map(train, ~lm(melanoma ~ edd_Summer + edd_Fall, data = .x)),
    
    #Four seasons
    four_seasons = map(train, ~lm(melanoma ~ edd_Fall +
                           edd_Winter +
                           edd_Spring +
                           edd_Summer, data = .x)),
    
    #Four seasons and state
    seasons_state  = map(train, ~lm(melanoma ~ ., data = .x)),
    
    #BIC model
    bic_fit = map(train, ~step_bic_mel_cty, data = .x)) %&gt;% 
  mutate(
    rmse_summer_edd = map2_dbl(summer_edd, test, ~rmse(model = .x, data = .y)),
    rmse_summer_fall = map2_dbl(summer_fall, test, ~rmse(model = .x, data = .y)),
    rmse_four_seasons = map2_dbl(four_seasons, test, ~rmse(model = .x, data = .y)),
    rmse_seasons_state = map2_dbl(seasons_state, test, ~rmse(model = .x, data = .y)),
    rmse_bic_fit = map2_dbl(bic_fit, test, ~rmse(model = .x, data = .y)))

cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  pivot_longer(
    everything(),
    names_to = &quot;model&quot;, 
    values_to = &quot;rmse&quot;,
    names_prefix = &quot;rmse_&quot;) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + geom_violin() + labs(x = &quot;Model&quot;, y = &quot;RMSE&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
<p>It looks like the interaction terms matter. Just how important are they?</p>
<pre class="r"><code>broom::tidy(step_bic_mel_cty) %&gt;%
  mutate(
    abs_t = abs(statistic),
    term = as.factor(term),
    term = fct_reorder(term, abs_t)
    ) %&gt;%
  ggplot(aes(x = abs_t, y = term)) +
  geom_col() +
  labs(title = &quot;Relative Importance of Model Terms&quot;,
       y = &quot;Model Term&quot;, x = &quot;|t| statistic&quot;)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
<p>That’s unintuitive. One might expect summer EDD would have the biggest effect on melanoma, but in this model the winter and spring EDD terms are the most important.</p>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
